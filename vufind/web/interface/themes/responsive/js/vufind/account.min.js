VuFind.Account=function(){return{ajaxCallback:null,closeModalOnAjaxSuccess:false,addList:function(){var form=$("#addListForm");var isPublic=form.find("#public").prop("checked");var recordId=form.find("input[name=recordId]").val();var source=form.find("input[name=source]").val();var title=form.find("input[name=title]").val();var desc=$("#listDesc").val();var url=Globals.path+"/MyResearch/AJAX";var params="method=AddList&"+"title="+encodeURIComponent(title)+"&"+"public="+isPublic+"&"+"desc="+encodeURIComponent(desc)+"&"+"recordId="+encodeURIComponent(recordId);$.ajax({url:url+"?"+params,dataType:"json",success:function(data){if(data.result){VuFind.showMessage("Added Successfully",data.message)}else{VuFind.showMessage("Error",data.message)}},error:function(){VuFind.showMessage("Error creating list","There was an unexpected error creating your list")}});return false},ajaxLogin:function(trigger,ajaxCallback,closeModalOnAjaxSuccess){if(Globals.loggedIn){if(ajaxCallback!=undefined&&typeof ajaxCallback==="function"){ajaxCallback()}else if(VuFind.Account.ajaxCallback!=null&&typeof VuFind.Account.ajaxCallback==="function"){VuFind.Account.ajaxCallback();VuFind.Account.ajaxCallback=null}}else{var multistep=false;if(ajaxCallback!=undefined&&typeof ajaxCallback==="function"){multistep=true}VuFind.Account.ajaxCallback=ajaxCallback;VuFind.Account.closeModalOnAjaxSuccess=closeModalOnAjaxSuccess;if(trigger!=undefined&&trigger!=null){var dialogTitle=trigger.attr("title")?trigger.attr("title"):trigger.data("title")}var dialogDestination=Globals.path+"/MyAccount/AJAX?method=LoginForm";if(multistep){dialogDestination+="&multistep=true"}var modalDialog=$("#modalDialog");$(".modal-body").html("Loading...");var modalBody=$(".modal-content");modalBody.load(dialogDestination);$(".modal-title").text(dialogTitle);modalDialog.modal("show")}return false},followLinkIfLoggedIn:function(trigger,linkDestination){if(trigger==undefined){alert("You must provide the trigger to follow a link after logging in.")}var jqTrigger=$(trigger);if(linkDestination==undefined){linkDestination=jqTrigger.attr("href")}this.ajaxLogin(jqTrigger,function(){document.location=linkDestination},true);return false},hasLocalStorage:function(){if(typeof arguments.callee.haslocalStorage=="undefined"){if("localStorage"in window){try{window.localStorage.setItem("_tmptest","temp");arguments.callee.haslocalStorage=window.localStorage.getItem("_tmptest")=="temp";window.localStorage.removeItem("_tmptest")}catch(error){arguments.callee.haslocalStorage=false}}else arguments.callee.haslocalStorage=false}return arguments.callee.haslocalStorage},preProcessLogin:function(){var username=$("#username").val(),password=$("#password").val(),loginErrorElem=$("#loginError");if(!username||!password){loginErrorElem.text("Please enter both your name and library card number").show();return false}if(VuFind.Account.hasLocalStorage()){var rememberMe=$("#rememberMe").prop("checked"),showPwd=$("#showPwd").prop("checked");if(rememberMe){window.localStorage.setItem("lastUserName",username);window.localStorage.setItem("lastPwd",password);window.localStorage.setItem("showPwd",showPwd);window.localStorage.setItem("rememberMe",rememberMe)}else{window.localStorage.removeItem("lastUserName");window.localStorage.removeItem("lastPwd");window.localStorage.removeItem("showPwd");window.localStorage.removeItem("rememberMe")}}return true},processAjaxLogin:function(ajaxCallback){if(VuFind.Account.preProcessLogin()){var username=$("#username").val(),password=$("#password").val(),rememberMe=$("#rememberMe").prop("checked"),loginErrorElem=$("#loginError"),url=Globals.path+"/AJAX/JSON?method=loginUser";loginErrorElem.hide();$.ajax({url:url,data:{username:username,password:password,rememberMe:rememberMe},success:function(response){if(response.result.success==true){$(".loginOptions, #loginOptions").hide();$(".logoutOptions, #logoutOptions").show();var name=response.result.name.trim();$("#header-container #myAccountNameLink").html(name);name="Logged In As "+name.slice(0,name.lastIndexOf(" ")+2)+".";$("#side-bar #myAccountNameLink").html(name);if(VuFind.Account.closeModalOnAjaxSuccess){VuFind.closeLightbox()}Globals.loggedIn=true;if(ajaxCallback!=undefined&&typeof ajaxCallback==="function"){ajaxCallback()}else if(VuFind.Account.ajaxCallback!=undefined&&typeof VuFind.Account.ajaxCallback==="function"){VuFind.Account.ajaxCallback();VuFind.Account.ajaxCallback=null}}else{loginErrorElem.text(response.result.message);loginErrorElem.show()}},error:function(){loginErrorElem.text("There was an error processing your login, please try again.").show()},dataType:"json",type:"post"})}return false},removeTag:function(tag){if(confirm('Are you sure you want to remove the tag "'+tag+'" from all titles?')){var url=Globals.path+"/MyAccount/AJAX?method=removeTag&tag="+encodeURI(tag);$.getJSON(url,function(data){if(data.result==true){VuFind.showMessage("Tag Deleted",data.message);setTimeout(function(){window.location.reload()},3e3)}else{VuFind.showMessage("Tag Not Deleted",data.message)}})}return false},renewTitle:function(renewIndicator){if(!Globals.loggedIn){VuFind.Account.ajaxLogin(null,function(){VuFind.Account.renewTitle(renewIndicator)},false)}else{VuFind.showMessage("Loading","Loading, please wait");$.getJSON("/MyAccount/AJAX?method=renewItem&renewIndicator="+renewIndicator,function(data){VuFind.showMessage(data.title,data.modalBody,data.success,data.success)}).fail(function(){VuFind.showMessage("Request Failed","There was an error with this AJAX Request.")})}return false},renewAll:function(){if(confirm("Renew All Items?")){if(!Globals.loggedIn){VuFind.Account.ajaxLogin(null,function(){VuFind.Account.renewAll()},false)}else{VuFind.showMessage("Loading","Loading, please wait");$.getJSON("/MyAccount/AJAX?method=renewAll",function(data){VuFind.showMessage(data.title,data.modalBody,data.success);if(data.success||data.renewed>0){$("#modalDialog").on("hidden.bs.modal",function(e){location.reload(true)})}}).fail(function(){VuFind.showMessage("Request Failed","There was an error with this AJAX Request.")})}}return false},renewSelectedTitles:function(){var selectedTitles=VuFind.getSelectedTitles();if(selectedTitles){if(confirm("Renew selected Items?")){if(!Globals.loggedIn){VuFind.Account.ajaxLogin(null,function(){VuFind.Account.renewSelectedTitles()},false)}else{VuFind.showMessage("Loading","Loading, please wait");$.getJSON("/MyAccount/AJAX?method=renewSelectedItems&"+selectedTitles,function(data){VuFind.showMessage(data.title,data.modalBody,data.success);if(data.success||data.renewed>0){$("#modalDialog").on("hidden.bs.modal",function(e){location.reload(true)})}}).fail(function(){VuFind.showMessage("Request Failed","There was an error with this AJAX Request.")})}}}return false},ajaxLightbox:function(urlToDisplay,requireLogin){if(requireLogin==undefined){requireLogin=false}if(requireLogin&&!Globals.loggedIn){VuFind.Account.ajaxLogin(null,function(){VuFind.Account.ajaxLightbox(urlToDisplay,requireLogin)},false)}else{var modalDialog=$("#modalDialog");$("#myModalLabel").html("Loading, please wait");$(".modal-body").html("...");$.getJSON(urlToDisplay,function(data){if(data.result){data=data.result}$("#myModalLabel").html(data.title);$(".modal-body").html(data.modalBody);$(".modal-buttons").html(data.modalButtons)});modalDialog.load();modalDialog.modal("show")}return false},cancelHold:function(holdIdToCancel){if(confirm("Are you sure you want to cancel this hold?")){if(!Globals.loggedIn){VuFind.Account.ajaxLogin(null,function(){VuFind.Account.cancelHold(holdIdToCancel)},false)}else{VuFind.showMessage("Loading","Loading, please wait");$.getJSON(Globals.path+"/MyAccount/AJAX?method=cancelHold&cancelId="+holdIdToCancel,function(data){VuFind.showMessage(data.title,data.modalBody,data.success);if(data.success){var escapedHoldId=holdIdToCancel.replace("~","\\~");$("div.result").has("#selected"+escapedHoldId).remove()}}).fail(function(){VuFind.showMessage("Request Failed","There was an error with this AJAX Request.")})}}return false},cancelSelectedHolds:function(){if(!Globals.loggedIn){VuFind.Account.ajaxLogin(null,function(){VuFind.Account.cancelSelectedHolds()},false)}else{var selectedTitles=this.getSelectedTitles().replace(/waiting|available/g,""),numHolds=$("input.titleSelect:checked").length;if(confirm("Cancel "+numHolds+" selected hold"+(numHolds>1?"s":"")+"?")){VuFind.showMessage("Loading","Loading, please wait");$.getJSON(Globals.path+"/MyAccount/AJAX?method=cancelHolds&"+selectedTitles,function(data){VuFind.showMessage(data.title,data.modalBody,data.success);if(data.success){$("input.titleSelect:checked").closest("div.result").remove()}else if(data.failed){$("input.titleSelect:checked").each(function(){var id=$(this).attr("id").replace(/selected/g,"");if($.inArray(id,data.failed)==-1)$(this).closest("div.result").remove()})}}).fail(function(){VuFind.showMessage("Request Failed","There was an error with this AJAX Request.")})}}return false},changeAccountSort:function(newSort){var currentLocation=window.location.href;if(currentLocation.match(/(accountSort=[^&]*)/)){currentLocation=currentLocation.replace(/accountSort=[^&]*/,"accountSort="+newSort)}else{if(currentLocation.match(/\?/)){currentLocation+="&accountSort="+newSort}else{currentLocation+="?accountSort="+newSort}}window.location.href=currentLocation},changeHoldPickupLocation:function(holdId){if(Globals.loggedIn){var modalDialog=$("#modalDialog");$("#myModalLabel").html("Loading");$(".modal-body").html("");$.getJSON(Globals.path+"/MyAccount/AJAX?method=getChangeHoldLocationForm&holdId="+holdId,function(data){$("#myModalLabel").html(data.title);$(".modal-body").html(data.modalBody);$(".modal-buttons").html(data.modalButtons)});modalDialog.load();modalDialog.modal("show")}else{VuFind.Account.ajaxLogin(null,function(){return VuFind.Account.changeHoldPickupLocation(holdId)},false)}return false},deleteSearch:function(searchId){if(!Globals.loggedIn){VuFind.Account.ajaxLogin(null,function(){VuFind.Searches.saveSearch(searchId)},false)}else{var url=Globals.path+"/MyAccount/AJAX";var params="method=deleteSearch&searchId="+encodeURIComponent(searchId);$.getJSON(url+"?"+params,function(data){if(data.result){VuFind.showMessage("Success",data.message)}else{VuFind.showMessage("Error",data.message)}})}return false},doChangeHoldLocation:function(){var holdId=$("#holdId").val();var newLocation=$("#newPickupLocation").val();var url=Globals.path+"/MyAccount/AJAX?method=changeHoldLocation&holdId="+encodeURIComponent(holdId)+"&newLocation="+encodeURIComponent(newLocation);$.getJSON(url,function(data){if(data.result){VuFind.showMessage("Success",data.message,true,true)}else{VuFind.showMessage("Error",data.message)}})},freezeHold:function(holdId,promptForReactivationDate,caller){if(promptForReactivationDate){var modalDialog=$("#modalDialog");$.getJSON(Globals.path+"/MyAccount/AJAX?method=getReactivationDateForm&holdId="+holdId,function(data){$("#myModalLabel").html(data.title);$(".modal-body").html(data.modalBody);$(".modal-buttons").html(data.modalButtons)});modalDialog.load();modalDialog.modal("show")}else{var popUpBoxTitle=$(caller).text()||"Freezing Hold";VuFind.showMessage(popUpBoxTitle,"Updating your hold.  This may take a minute.");var url=Globals.path+"/MyAccount/AJAX?method=freezeHold&holdId="+holdId;$.getJSON(url,function(data){if(data.result){VuFind.showMessage("Success",data.message,true,true)}else{VuFind.showMessage("Error",data.message)}})}},doFreezeHoldWithReactivationDate:function(caller){var popUpBoxTitle=$(caller).text()||"Freezing Hold";var holdId=$("#holdId").val();var reactivationDate=$("#reactivationDate").val();var url=Globals.path+"/MyAccount/AJAX?method=freezeHold&holdId="+holdId+"&reactivationDate="+reactivationDate;VuFind.showMessage(popUpBoxTitle,"Updating your hold.  This may take a minute.");$.getJSON(url,function(data){if(data.result){VuFind.showMessage("Success",data.message,true,true)}else{VuFind.showMessage("Error",data.message)}})},freezeSelectedHolds:function(){var selectedTitles=this.getSelectedTitles();if(selectedTitles.length==0){return false}var suspendDate="";var suspendDateTop=$("#suspendDateTop");var url="";var queryParams="";if(suspendDateTop.length){if(suspendDateTop.val().length>0){suspendDate=suspendDateTop.val()}else{suspendDate=$("#suspendDateBottom").val()}if(suspendDate.length==0){alert("Please select the date when the hold should be reactivated.");return false}url=Globals.path+"/MyAccount/Holds?multiAction=freezeSelected&"+selectedTitles+"&suspendDate="+suspendDate;queryParams=VuFind.getQuerystringParameters();if($.inArray("section",queryParams)){url+="&section="+queryParams["section"]}window.location=url}else{url=Globals.path+"/MyAccount/Holds?multiAction=freezeSelected&"+selectedTitles+"&suspendDate="+suspendDate;queryParams=VuFind.getQuerystringParameters();if($.inArray("section",queryParams)){url+="&section="+queryParams["section"]}window.location=url}return false},getSelectedTitles:function(promptForSelectAll){if(promptForSelectAll==undefined){promptForSelectAll=true}var selectedTitles=$("input.titleSelect:checked ");if(selectedTitles.length==0&&promptForSelectAll&&confirm("You have not selected any items, process all items?")){selectedTitles=$("input.titleSelect").attr("checked","checked")}var queryString=selectedTitles.map(function(){return $(this).attr("name")+"="+$(this).val()}).get().join("&");return queryString},saveSearch:function(searchId){if(!Globals.loggedIn){VuFind.Account.ajaxLogin(null,function(){VuFind.Searches.saveSearch(searchId)},false)}else{var url=Globals.path+"/MyAccount/AJAX";var params="method=saveSearch&searchId="+encodeURIComponent(searchId);$.getJSON(url+"?"+params,function(data){if(data.result){VuFind.showMessage("Success",data.message)}else{VuFind.showMessage("Error",data.message)}})}return false},showCreateListForm:function(id){if(Globals.loggedIn){var modalDialog=$("#modalDialog");var url=Globals.path+"/MyResearch/AJAX?method=getCreateListForm";if(id!=undefined){url+="&recordId="+encodeURIComponent(id)}$.getJSON(url,function(data){$("#myModalLabel").html(data.title);$(".modal-body").html(data.modalBody);$(".modal-buttons").html(data.modalButtons)});modalDialog.load();modalDialog.modal("show")}else{VuFind.Account.ajaxLogin($trigger,function(){return VuFind.GroupedWork.showEmailForm(trigger,id)},false)}return false},thawHold:function(holdId,caller){$popUpBoxTitle=$(caller).text()||"Thawing Hold";VuFind.showMessage($popUpBoxTitle,"Updating your hold.  This may take a minute.");var url=Globals.path+"/MyAccount/AJAX?method=thawHold&holdId="+holdId;$.getJSON(url,function(data){if(data.result){VuFind.showMessage("Success",data.message,true,true)}else{VuFind.showMessage("Error",data.message)}})}}}(VuFind.Account||{});